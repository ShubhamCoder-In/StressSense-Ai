<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Take Assignment | StressSence AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(255,255,255,0.9);
      padding: 15px 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 0 0 15px 15px;
    }
    header h1 { margin: 0; font-size: 1.8rem; color: #333; }
    .assignment-card {
      max-width: 700px;
      margin: 20px auto;
      padding: 30px;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .progress { height: 20px; margin-bottom: 20px; border-radius: 10px; overflow: hidden; }
    .progress-bar { transition: width 0.3s ease; }
    footer {
      background: rgba(255,255,255,0.9);
      text-align: center;
      padding: 15px 0;
      margin-top: auto;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
      border-radius: 15px 15px 0 0;
      font-size: 0.9rem;
      color: #333;
    }
    .btn { border-radius: 50px; }

    /* ðŸŽ¤ Mic Button Styles */
    .textarea-wrapper { position: relative; }
    .mic-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #2575fc;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      color: #fff;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .mic-btn.listening {
      background: #ff3b3b;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px #ff3b3b; }
      50% { box-shadow: 0 0 20px #ff3b3b; }
      100% { box-shadow: 0 0 5px #ff3b3b; }
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <h1><a href="{{ url_for('user.dashboard') }}" class="text-decoration-none text-dark"><i class="bi bi-mortarboard-fill me-2"></i>StressSence AI - Take Assignment</a></h1>
  <span th:text="'Hello, ' + ${user.name}">Hello, Student</span>
</header>

<!-- Main Container -->
<div class="container flex-grow-1">
  <div class="assignment-card">
    <h4 class="mb-3 text-center">Answer Questions to Complete Your Assignment</h4>
    <div class="progress">
      <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
    </div>

    <div id="questionContainer"></div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2">
        <button id="prevBtn" class="btn btn-secondary">Previous</button>
        <button id="nextBtn" class="btn btn-primary">Next</button>
      </div>
      <a href="{{ url_for('user.dashboard') }}" class="btn btn-warning align-self-center">Leave Assignment</a>
    </div>

    <div id="message" class="mt-3"></div>
  </div>
</div>

<!-- Footer -->
<footer>
  &copy; 2025 StressSence AI. All rights reserved.
</footer>

<script type="text/javascript">
  const surveyQuestions = {
    "Difficulty & Understanding": [
      "Which topics or subjects do you find most difficult to understand, and why?",
      "Are there any concepts you repeatedly struggle with?",
      "Do you feel confident about what you have learned so far?",
      "How do you approach topics that you find challenging?"
    ],
    "Motivation & Engagement": [
      "How motivated do you feel to study and complete your assignments these days?",
      "What factors keep you engaged or demotivated in your studies?",
      "How do you feel when you have to start a new topic or assignment?"
    ],
    "Stress & Anxiety": [
      "How stressed do you feel about upcoming exams or deadlines?",
      "What situations during your studies make you feel anxious or overwhelmed?",
      "How does academic pressure affect your mood or focus?",
      "How confident or anxious do you feel when exams approach?"
    ],
    "Time Management & Coping": [
      "How do you manage your study time and deadlines?",
      "When you feel overwhelmed by studies, what strategies do you use to cope?",
      "Do you take breaks or use any specific methods to reduce stress while studying?",
      "Do you feel your current study routine impacts your sleep, health, or personal life?"
    ]
  };

  const questionList = [];
  for (const category in surveyQuestions) {
    surveyQuestions[category].forEach(q => {
      questionList.push({ category, question: q });
    });
  }

  let currentIndex = 0;

  const assignmentPayload = {
    assignmentId: "12345",
    startedAt: new Date().toISOString(),
    completedAt: null,
    categories: []
  };

  const questionContainer = document.getElementById("questionContainer");
  const progressBar = document.getElementById("progressBar");
  const messageDiv = document.getElementById("message");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = true;
  }

  function loadQuestion() {
    const qObj = questionList[currentIndex];
    const prevAnswer = getAnswer(qObj.category, qObj.question);

    questionContainer.innerHTML = `
      <h5>${qObj.category}</h5>
      <p>${qObj.question}</p>
      <div class="textarea-wrapper">
        <textarea id="answerInput" class="form-control" rows="4" placeholder="Write your answer here..." required>${prevAnswer || ''}</textarea>
        <button id="micBtn" type="button" class="mic-btn">
          <i class="bi bi-mic-fill"></i>
        </button>
      </div>
    `;

    progressBar.style.width = `${((currentIndex+1)/questionList.length)*100}%`;
    prevBtn.disabled = currentIndex === 0;
    nextBtn.textContent = currentIndex === questionList.length - 1 ? "Submit" : "Next";

    const micBtn = document.getElementById("micBtn");
    const answerInput = document.getElementById("answerInput");
    if (recognition) {
      micBtn.addEventListener("click", () => {
        if (micBtn.classList.contains("listening")) {
          recognition.stop();
          micBtn.classList.remove("listening");
        } else {
          recognition.start();
          micBtn.classList.add("listening");
        }
      });

      recognition.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            transcript += event.results[i][0].transcript;
          }
        }
        if (transcript.trim() !== "") {
          answerInput.value = (answerInput.value + " " + transcript).trim();
        }
      };

      recognition.onerror = (event) => { micBtn.classList.remove("listening"); };
      recognition.onend = () => { micBtn.classList.remove("listening"); };
    }
  }

  function getAnswer(category, question) {
    const catObj = assignmentPayload.categories.find(c => c.categoryName === category);
    if (!catObj) return null;
    const quesObj = catObj.questions.find(q => q.question === question);
    return quesObj ? quesObj.answer : null;
  }

  async function saveAnswer() {
    const answer = document.getElementById("answerInput").value.trim();
    const currentCategory = questionList[currentIndex].category;
    const currentQuestion = questionList[currentIndex].question;

    let catObj = assignmentPayload.categories.find(c => c.categoryName === currentCategory);
    if (!catObj) {
      catObj = { categoryName: currentCategory, questions: [] };
      assignmentPayload.categories.push(catObj);
    }

    let quesObj = catObj.questions.find(q => q.question === currentQuestion);
    if (!quesObj) {
      quesObj = { question: currentQuestion, answer: answer, prediction: null };
      catObj.questions.push(quesObj);
    } else {
      quesObj.answer = answer;
    }

    if (answer !== "") {
      try {
        const res = await fetch("/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: answer })
        });
        if (res.ok) {
          const pred = await res.json();
          quesObj.prediction = pred || null;
        } else { quesObj.prediction = null; }
      } catch (err) {
        quesObj.prediction = null;
      }
    } else { quesObj.prediction = null; }
  }

  nextBtn.addEventListener("click", async () => {
    await saveAnswer();
    if (currentIndex < questionList.length - 1) {
      currentIndex++;
      loadQuestion();
    } else {
      assignmentPayload.completedAt = new Date().toISOString();
      try {
        const response = await fetch("/submit-assignment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(assignmentPayload)
        });
        if (response.ok) {
          const result = await response.json();
          messageDiv.innerHTML = `<div class="alert alert-success">${result.message || 'Assignment submitted successfully!'}</div>`;
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger">Failed to submit assignment!</div>`;
        }
      } catch (err) {
        messageDiv.innerHTML = `<div class="alert alert-danger">Network error: ${err.message}</div>`;
      }
    }
  });

  prevBtn.addEventListener("click", async () => {
    await saveAnswer();
    if (currentIndex > 0) {
      currentIndex--;
      loadQuestion();
    }
  });

  loadQuestion();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
