<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suggestions | StressSense AI</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f6fa; margin: 0; }
    .wrapper { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background: #2c3e50; color: white; padding-top: 20px; }
    .sidebar a { color: white; text-decoration: none; display: block; padding: 15px; }
    .sidebar a:hover { background: #34495e; }
    .sidebar .active { background: #1abc9c; }
    .content { flex-grow: 1; padding: 30px; background: #f5f6fa; overflow-y: auto; }
    .card { border-radius: 12px; margin-bottom: 20px; }
    .suggestion-item { background: #eaf6f6; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .suggestion-item:hover { background: #d1f2eb; cursor: pointer; transition: 0.3s; }
    #loading { display: none; }
  </style>
</head>
<body>

<div class="wrapper">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3 class="text-center">StressSense AI</h3>
    <hr>
    <a href="{{ url_for('user.dashboard') }}"><i class="bi bi-house-fill me-2"></i> Dashboard</a>
    <a href="{{ url_for('user.profile') }}" class="active"><i class="bi bi-person-fill me-2"></i> Profile</a>
    <a href="{{ url_for('user.assessments') }}"><i class="bi bi-bar-chart-fill me-2"></i> Assessments</a>
    <a href="{{ url_for('user.suggestions') }}"><i class="bi bi-lightbulb-fill me-2"></i> Suggestions</a>
    <a href="{{ url_for('user.logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content">
    <h2 class="mb-4"><i class="bi bi-lightbulb-fill"></i> Personalized Suggestions</h2>

    <!-- Survey Selection -->
    <div id="surveySelection" class="mb-4">
      <h5>Select a Survey:</h5>
      <div id="surveyList" class="list-group mb-2"></div>
      <button id="startSurveyBtn" class="btn btn-primary" disabled>Fetch Suggestions</button>
    </div>

    <div id="loading" class="alert alert-info">
      Fetching suggestions from Gemini AI...
    </div>

    <div id="suggestions-container"></div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const GEMINI_API_KEY = "AIzaSyAUfdhgGf14ccrIQpbw6RSuzRMGWIxCaRU"; // Replace with your key
const suggestionsContainer = document.getElementById('suggestions-container');
const loading = document.getElementById('loading');

let selectedSurveyId = null;
const userId = "{{ user._id }}"; // From session

// Fetch user's surveys
async function loadSurveys() {
   try {
    const res = await fetch(`/get-assignments/${userId}`);
    const data = await res.json();
    console.log(data);
    // container.innerHTML = "";

    if (!data || data.length === 0) {
    //   container.innerHTML = "<p>No assignments submitted yet.</p>";

      return;
    }

    data.forEach((assignment, index) => {
  const item = document.createElement("button");
  item.className = "list-group-item list-group-item-action";

  // Show assignment number + submitted date
  const submitted = assignment.submittedAt 
      ? new Date(assignment.submittedAt).toLocaleString() 
      : "Not submitted";

  item.textContent = `Assignment ${index + 1} (Submitted: ${submitted})`;

  item.onclick = () => {
    selectedSurveyId = assignment.assignmentId; // use assignmentId
    document.querySelectorAll("#surveyList button").forEach(b => b.classList.remove("active"));
    item.classList.add("active");
    document.getElementById("startSurveyBtn").disabled = false;
  };

  surveyList.appendChild(item);
});

  } catch (err) {
    console.error("Error loading surveys:", err);
  }
}

// Filter payload to include only categories with answers
function filterPayload(payload) {
  return { categories: payload.categories.filter(cat => cat.questions && cat.questions.length > 0) };
}

// Generate prompt for Gemini
function generatePrompt(filteredPayload) {
  return `Analyze the following student responses and provide structured analysis and actionable suggestions:\n\n${JSON.stringify(filteredPayload, null, 2)}`;
}

// Clean Gemini text
function cleanText(text) {
  return text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/^- /gm, '').replace(/^#*/gm, '').replace(/\s{2,}/g, ' ').trim();
}

// Fetch assignments for the selected survey
async function fetchAssignments(surveyId) {
  try {
    const res = await fetch(`/get-assignments/${userId}?surveyId=${surveyId}`);
    const assignments = await res.json();

    if (!assignments || assignments.length === 0) return null;

    // For simplicity, take the latest completed assignment
    const latest = assignments[assignments.length - 1];
    return latest;
  } catch (err) {
    console.error("Error fetching assignments:", err);
    return null;
  }
}

// Fetch Gemini suggestions
async function fetchGeminiSuggestions(prompt) {
  loading.style.display = 'block';
  try {
    const response = await fetch(
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }]
        })
      }
    );

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    return cleanText(text);
  } catch (err) {
    console.error(err);
    return "Failed to fetch suggestions from Gemini.";
  } finally {
    loading.style.display = 'none';
  }
}

// Render suggestions as cards
function renderSuggestions(text) {
  suggestionsContainer.innerHTML = "";

  if (!text) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger';
    alert.innerText = "No suggestions available.";
    suggestionsContainer.appendChild(alert);
    return;
  }

  const lines = text.split('\n').filter(line => line.trim() !== "");
  lines.forEach(line => {
    const card = document.createElement('div');
    card.className = 'card shadow-sm p-3 mb-2';
    const p = document.createElement('p');
    p.innerText = line;
    card.appendChild(p);
    suggestionsContainer.appendChild(card);
  });
}

// Start survey button
document.getElementById("startSurveyBtn").addEventListener("click", async () => {
  if (!selectedSurveyId) return;

  const assignment = await fetchAssignments(selectedSurveyId);
  if (!assignment || !assignment.categories || assignment.categories.length === 0) {
    renderSuggestions("No student answers provided to analyze.");
    return;
  }

  const filteredPayload = filterPayload(assignment);
  const prompt = generatePrompt(filteredPayload);
  const resultText = await fetchGeminiSuggestions(prompt);
  renderSuggestions(resultText);
});

// Initial load
loadSurveys();
</script>

</body>
</html>
